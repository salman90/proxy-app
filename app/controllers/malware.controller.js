const db  = require("../models");
const MalwareURL = db.DevDB.malware;
const Op = db.DevDB.Sequelize.Op;
const { validationResult } = require('express-validator');


/**
 * 
 * @param {Object} req 
 * @param {Object} res 
 * @returns create a new records in the database and returns a responed
 */
exports.create = (req, res) => {

    
    const errors = validationResult(req);
    if(!errors.isEmpty()){
        return res.status(422).jsonp(errors.array());
    }else {
       let url =  { address: req.body.address } 
        MalwareURL.create(url)
        .then(data => {
            res.send(data); 
        })
        .catch(err => {
            res.status(500).send({
                message:
                    err.message || "Some error occurred while creating the Tutorial."
            });
        });
    }
    

};



/**
 * @deprecated takes a request and returns a responed
 * @param {Object} req 
 * @param {Object} res 
 * @param {Object} next 
 */
exports.findURL = (req, res, next) => {
    let hostname = req.params.hostname;

    if (hostname.includes(":")) {
        let hostAndPortArray = hostname.split(':');
        hostname = hostAndPortArray[0];
        port = hostAndPortArray[1];
    }

    /**
     * @deprecated queries database to find hostname
     */
    MalwareURL.findOne({ where: { address: hostname} })
     .then(data => {
         let port = '';
         let url = req.originalUrl.replace('/urlinfo/1/', '');
         let path = req.params[0] ? req.params[0] : '';

         let queryString = (req.query && Object.keys(req.query).length > 0) ? req.query : '';
         let host = req.get('host');
         let resObject = {};         

         if(data != null){
             resObject = {
                 message: 'URL is not safe to visit',
                 hostname: hostname,
                 port: port,
                 path: path,
                 url: url,
                 queryString: {
                     ...queryString
                 },
                 serverHost: host,
             };
         }else {
             resObject = {
                 message: 'URL is safe to be visit',
                 hostname: hostname,
                 port: port,
                 path: path,
                 url: url,
                 queryString: {
                     ...queryString
                 },
                 serverHost: host,
             };
         }
         res.json(resObject);
     }).catch(err => {
         next(err)
     })

}