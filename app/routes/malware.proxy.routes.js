/**
 * routes for applciaiton and proxy installation
 * @param {Object} app
 */
module.exports = app => {
    const router = require("express").Router();
    const { createProxyMiddleware } = require('http-proxy-middleware');

    const targets = [
        'http://localhost:8000',
        'http://localhost:9000',
        'http://localhost:1000'
    ]

    /**
     * @description routes proxy to pick on of the options in target array
     */
    const customRouter = function (req) {
        return targets[Math.floor(Math.random() * 3)];
    }

    /**
     * 
     * @param {String} path 
     * @param {Object} req 
     * @returns adds the right path to on of options in the target arrayx
     */
    const rewriteFn = function (path, req) {
        let hostname = req.params.hostname;
        let pathEnd = req.params[0];
        if (pathEnd) {
            return path.replace(`/urlinfo/1/${hostname}/${pathEnd}`, `/urlinfo/1/${hostname}/${pathEnd}`);
        } else {
            return path.replace(`/urlinfo/1/${hostname}`, `/urlinfo/1/${hostname}`);

        }
    };

    const options = {
        target: 'http://localhost:8000', 
        router: customRouter,
        changeOrigin: true,
        pathRewrite: rewriteFn,
    } 

    const optionsForPost = {
        target: 'http://localhost:8000',
        router: customRouter,
        changeOrigin: true,
        pathRewrite:{
            '^/urlinfo/1/create': '/urlinfo/1/create',
        } 
    }

    const proxyForGet  = createProxyMiddleware(options);
    const proxyForPost = createProxyMiddleware(optionsForPost);

    router.post("/urlinfo/1/create", proxyForPost);
    router.get("/urlinfo/1/:hostname/*", proxyForGet);
    router.use("/urlinfo/1/:hostname", proxyForGet);
    app.use('/', router);
}